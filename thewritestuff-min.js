/*thewritestuff.js
@author: Matthew Story <matt@tablethotels.com>
@version: 0.9
@license: BSD (see LICENSE)
@copyright: 2011, Tablet Inc*/
var Writes={writes:[],inprocess:[],remaining:[],work:[],workIndex:false,workWrite:false,waiting:false,writing:false,scriptTag:/<[Ss][Cc][Rr][Ii][Pp][Tt][^>]*>[\S\s]*?<\/[Ss][Cc][Rr][Ii][Pp][Tt]>/g,finishScriptTag:false,div:document.createElement("div"),waitingToWrite:[],register:function(a){if(this.writing){this.inprocess.push(a);return}this.writes.push(a);this.fire()},unregister:function(b){var c=[];for(var a=0;a<this.writes.length;a++){if(this.writes[a]!=b){c.push(this.writes[a])}}this.writes=c},fire:function(){if(!this.waiting){window.setTimeout(this.bind(this.write,this),0)}this.waiting=true},write:function(a){this.writing=true;a=(a&&a.constructor==Array)?a:this.writes;if(this.writeParts(this.uniqueifyWrites(a))){this.clear();this.onFinish()}},uniqueifyWrites:function(d){var a=[];for(var c=0;c<d.length;c++){var b=this.getKeyFromBind(d[c].bind,a);if(b<0){a.push(new Write("",d[c].bind,{register:false}));b=a.length-1}a[b].str+=d[c].str}return a},writeParts:function(b){for(var a=0;a<b.length;a++){if(!this.writePart(b[a],b.slice(a+1)||[])){return false}}return true},writePart:function(a,b){var c=this.writeAndReplaceScripts(a,b);if(!c&&c.constructor!=String){return false}else{if(c.constructor==String){this.appendChildren(a.bind,this.arrayify(this.getChildrenFromString(c)))}}return true},writeAndReplaceScripts:function(c,d){var a=this.splitStringByScripts(c.str);for(var b=0;b<a.length;b++){if(a[b].match(this.scriptTag)){this.work=a;this.workIndex=b;this.workWrite=c;this.remaining=d;this.appendChildren(c.bind,this.arrayify(this.getChildrenFromString(a[b])));return false}}return(a.length)?a.join(""):true},splitStringByScripts:function(a){return this.zipper(a.split(this.scriptTag)||[],a.match(this.scriptTag)||[])},finish:function(){this.work[this.workIndex]="";for(var a=0;a<this.inprocess.length;a++){this.work[this.workIndex]+=this.inprocess[a].str}this.workWrite.str=this.work.join("");var b=[this.workWrite].concat(this.remaining);this.clearInProcess();this.write(b)},onReadyStateChange:function(a){if(a.srcElement.readyState=="complete"||a.srcElement.readyState=="loaded"||a.srcElement.readyState=="interactive"){this.stopObserving(a.srcElement,"readystatechange",this.onReadyStateChangeHandler);this.finish()}},clear:function(){this.clearInProcess();this.waiting=false;this.writing=false;this.writes=[]},clearInProcess:function(){this.inprocess=[];this.remaining=[];this.workWrite=[];this.work=[];this.workIndex=false},bindWrites:function(b,c){for(var a=0;a<b.length;a++){b.bind=c}return b},bind:function(b,a){return function(){b.apply(a,arguments)}},appendChildren:function(c,b){for(var a=0;a<b.length;a++){if(b[a].tagName=="SCRIPT"){if(!!(window.attachEvent&&!window.opera)){var d=b[a]}else{var d=b[a].cloneNode(true)}if(!d.src&&!d.SRC){c.appendChild(d);c.appendChild((!!(window.attachEvent&&!window.opera))?this.finishScript():this.finishScript().cloneNode(true))}else{if(!!(window.attachEvent&&!window.opera)){this.onReadyStateChangeHandler=this.bind(this.onReadyStateChange,this);Writes.observe(d,"readystatechange",this.onReadyStateChangeHandler)}else{Writes.observe(d,"load",this.bind(this.finish,this))}c.appendChild(d)}}else{c.appendChild(b[a])}}},getChildrenFromString:function(a){if(a.match(this.scriptTag)){return[this.buildScriptTagFromString(a)]}this.div.innerHTML=a;return this.div.childNodes},buildScriptTagFromString:function(d){var c=this.makeKeyValuePairs(d);var b=document.createElement("script");for(var a in c){b.setAttribute(a,c[a])}var e=d.replace(/<[Ss][Cc][Rr][Ii][Pp][Tt][^>]*>([\S\s]*?)<\/[Ss][Cc][Rr][Ii][Pp][Tt]>/g,"$1");if(e){if(!!(window.attachEvent&&!window.opera)){b.text=e}else{b.appendChild(document.createTextNode(e))}}return b},makeKeyValuePairs:function(c){c=c.replace(/<[Ss][Cc][Rr][Ii][Pp][Tt]([^>]*)>[\S\s]*/g,"$1");c=(c&&!c.split(" "))?[c]:c.split(" ");var b={};for(var a=0;a<c.length;a++){c[a]=c[a].split("=");if(c[a].length==2){b[c[a][0].replace(/^[Ss][Rr][Cc]$/g,"src")]=c[a][1].replace(/(^\s*['"])|(['"]\s*$)/g,"")}}return b},getKeyFromBind:function(c,b){for(var a=0;a<b.length;a++){if(c==b[a].bind){return a}}return -1},zipper:function(c,b){var a=[];for(var d=0;d<((c.length>b.length)?c.length:b.length);d++){if(d<c.length){a.push(c[d])}if(d<b.length){a.push(b[d])}}return a},finishScript:function(){if(!!(window.attachEvent&&!window.opera)){this.finishScriptTag=false}if(!this.finishScriptTag){this.finishScriptTag=document.createElement("script");this.finishScriptTag.type="text/javascript";var a="window.setTimeout(Writes.bind(Writes.finish, Writes), 0);";if(!!(window.attachEvent&&!window.opera)){this.finishScriptTag.text=a}else{this.finishScriptTag.appendChild(document.createTextNode(a))}}return this.finishScriptTag},arrayify:function(c){var a=[];for(var b=0;b<c.length;b++){a.push(c[b])}return a},observe:function(b,a,c){if(b.addEventListener){b.addEventListener(a,c,false)}else{b.attachEvent("on"+a,c)}},stopObserving:function(b,a,c){if(b.removeEventListener){b.removeEventListener(a,c,false)}else{b.detachEvent("on"+a,c)}},onFinish:function(){if(Writes.waitingToWrite.length){(Writes.waitingToWrite.shift())()}},load:function(){var a=(navigator.userAgent.indexOf("AppleWebKit/")>-1)?document.getElementsByTagName("img"):[];if(!a.length||a[a.length-1].complete){this.onLoad();return}window.setTimeout(this.bind(this.load,this),100)},onLoad:function(){document.write=function(a){new Write(a,this)};this.onFinish()}};Writes.observe(window,"load",Writes.bind(Writes.load,Writes));var Write=function(){this.init.apply(this,arguments)};Write.prototype={init:function(a,b){this.options=this.extend({register:true},arguments[2]);this.str=a;this.bind=(!b||b==document||b==window)?document.body:b;if(this.options.register){Writes.register(this)}},extend:function(c,b){for(var a in b){c[a]=b[a]}return c}};
